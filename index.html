<html>

<head>
  <title>Urban Landscape of Central Europe</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" type="text/css" href="./tree-of-life/inspector.css">
  <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.0.1/dist/maplibre-gl.css' />
  <script src='https://unpkg.com/maplibre-gl@5.0.1/dist/maplibre-gl.js'></script>
  <script src="https://unpkg.com/pmtiles@4.2.1/dist/pmtiles.js"></script>
  <style>
    body {
      margin: 0;
    }

    #map {
      height: 100%;
      width: 100%;
    }
  </style>
</head>

<body>

  <div id="tree-of-life-output"
    style="position: absolute; bottom: 50px; left: 50px; padding: 10px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 1; width: 900px;">
  </div>
  <script type="module">
    import define from "./tree-of-life/index.js";
    import { Runtime, Library, Inspector } from "./tree-of-life/runtime.js";

    const runtime = new Runtime();
    const treeOfLifeOutput = document.getElementById('tree-of-life-output');
    const main = runtime.module(define, Inspector.into(treeOfLifeOutput));
  </script>

  <div id="map"></div>
  <script type="text/javascript">
    // add the PMTiles plugin to the maplibregl global.
    // setting metadata = true fills out the "attribution" field of the source, and is required for some inspector applications,
    // but requires an additional blocking HTTP request before loading the map.
    let protocol = new pmtiles.Protocol({ metadata: true });
    maplibregl.addProtocol("pmtiles", protocol.tile);

    const map = new maplibregl.Map({
      style: "https://basemaps.cartocdn.com/gl/dark-matter-nolabels-gl-style/style.json",
      container: "map",
      zoom: 13,
      center: [14.436035, 50.078292],
    });
    map.showTileBoundaries = false;
    map.on('load', function () {
      map.addSource('buildings-source', {
        type: 'vector',
        // url: 'pmtiles://http://127.0.0.1:8000/86873.pmtiles'   // use this when developing locally
        url: 'pmtiles://https://s3.cl4.du.cesnet.cz/4f4743b6_4043_4e02_a3ba_0452aa7523a2:uscuni-public/complete.pmtiles'
      });

      const mapping = {
        "1": "1",
        "2": "1",
        "3": "1",
        "4": "1",
        "5": "1",
        "6": "1",
        "7": "2",
        "8": "2",
        "9": "2",
        "10": "2",
        "11": "2",
        "12": "3",
        "13": "3",
        "14": "3",
        "15": "3",
        "16": "3",
        "17": "4",
        "18": "4",
        "19": "4",
        "20": "5",
        "21": "5",
        "22": "5",
        "23": "5",
        "24": "5",
        "25": "5",
        "26": "5",
        "27": "5",
        "28": "6",
        "29": "6",
        "30": "6",
        "31": "6",
        "32": "6",
        "33": "6",
        "34": "6",
        "35": "6",
        "36": "7",
        "37": "7",
        "38": "7",
        "39": "7",
        "40": "7",
        "41": "7",
        "42": "7",
        "43": "7",
        "44": "8",
        "45": "8",
        "46": "8",
        "47": "8",
        "48": "8",
        "49": "8",
        "50": "8",
        "51": "8",
        "52": "9",
        "53": "9",
        "54": "9",
        "55": "9",
        "56": "9",
        "57": "9",
        "58": "9",
        "59": "9",
        "60": "10",
        "61": "10",
        "62": "10",
        "63": "10",
        "64": "10",
        "65": "11",
        "66": "11",
        "67": "11",
        "68": "11",
        "69": "11",
        "70": "11",
        "71": "11",
        "72": "11",
        "73": "12",
        "74": "12",
        "75": "12",
        "76": "12",
        "77": "12",
        "78": "12",
        "79": "12",
        "80": "12",
        "81": "13",
        "82": "13",
        "83": "13",
        "84": "13",
        "85": "13",
        "86": "13",
        "87": "13",
        "88": "13",
        "89": "14",
        "90": "14",
        "91": "14",
        "92": "14",
        "93": "14",
        "94": "14",
        "95": "14",
        "96": "14",
        "97": "15",
        "98": "15",
        "99": "15",
        "100": "15",
        "101": "15",
        "102": "16",
        "103": "16",
        "104": "16",
        "105": "16",
        "106": "16",
        "107": "16",
        "108": "16"
      };



      const fillColor = [
        "match",
        ["get", "final_without_noise"],
        '1', '#1cae75',
        '2', '#1cae75',
        '3', '#1cae75',
        '4', '#1cae75',
        '5', '#1cae75',
        '6', '#1cae75',
        '7', '#922800',
        '8', '#922800',
        '9', '#922800',
        '10', '#922800',
        '11', '#922800',
        '12', '#6da2ff',
        '13', '#6da2ff',
        '14', '#6da2ff',
        '15', '#6da2ff',
        '16', '#6da2ff',
        '17', '#38a6a5',
        '18', '#38a6a5',
        '19', '#38a6a5',
        '20', '#94346e',
        '21', '#94346e',
        '22', '#94346e',
        '23', '#94346e',
        '24', '#94346e',
        '25', '#94346e',
        '26', '#94346e',
        '27', '#94346e',
        '28', '#73af48',
        '29', '#73af48',
        '30', '#73af48',
        '31', '#73af48',
        '32', '#73af48',
        '33', '#73af48',
        '34', '#73af48',
        '35', '#73af48',
        '36', '#1d6996',
        '37', '#1d6996',
        '38', '#1d6996',
        '39', '#1d6996',
        '40', '#1d6996',
        '41', '#1d6996',
        '42', '#1d6996',
        '43', '#1d6996',
        '44', '#0f8554',
        '45', '#0f8554',
        '46', '#0f8554',
        '47', '#0f8554',
        '48', '#0f8554',
        '49', '#0f8554',
        '50', '#0f8554',
        '51', '#0f8554',
        '52', '#354dbe',
        '53', '#354dbe',
        '54', '#354dbe',
        '55', '#354dbe',
        '56', '#354dbe',
        '57', '#354dbe',
        '58', '#354dbe',
        '59', '#354dbe',
        '60', '#edad08',
        '61', '#edad08',
        '62', '#edad08',
        '63', '#edad08',
        '64', '#edad08',
        '65', '#dba2ff',
        '66', '#dba2ff',
        '67', '#dba2ff',
        '68', '#dba2ff',
        '69', '#dba2ff',
        '70', '#dba2ff',
        '71', '#dba2ff',
        '72', '#dba2ff',
        '73', '#a65904',
        '74', '#a65904',
        '75', '#a65904',
        '76', '#a65904',
        '77', '#a65904',
        '78', '#a65904',
        '79', '#a65904',
        '80', '#a65904',
        '81', '#3d6100',
        '82', '#3d6100',
        '83', '#3d6100',
        '84', '#3d6100',
        '85', '#3d6100',
        '86', '#3d6100',
        '87', '#3d6100',
        '88', '#3d6100',
        '89', '#aeb6ef',
        '90', '#aeb6ef',
        '91', '#aeb6ef',
        '92', '#aeb6ef',
        '93', '#aeb6ef',
        '94', '#aeb6ef',
        '95', '#aeb6ef',
        '96', '#aeb6ef',
        '97', '#f79e8e',
        '98', '#f79e8e',
        '99', '#f79e8e',
        '100', '#f79e8e',
        '101', '#f79e8e',
        '102', '#6f4070',
        '103', '#6f4070',
        '104', '#6f4070',
        '105', '#6f4070',
        '106', '#6f4070',
        '107', '#6f4070',
        '108', '#6f4070',
        "#cccccc" // default color
      ];

      map.addLayer({
        id: 'buildings',
        type: 'fill',
        source: 'buildings-source',
        maxzoom: 24,
        'source-layer': 'buildings',
        paint: {
          "fill-color": fillColor,
        },
      });

      // show the cluster on click
      map.on('click', 'buildings', function (e) {
        new maplibregl.Popup()
          .setLngLat(e.lngLat)
          .setHTML('final_without_noise: ' + e.features[0].properties.final_without_noise + '<br />final: ' + e.features[0].properties.final)
          .addTo(map);
      });

      map.on('mouseenter', 'buildings', function () {
        map.getCanvas().style.cursor = 'pointer';
      });

      map.on('mouseleave', 'buildings', function () {
        map.getCanvas().style.cursor = '';
      });

      // add morphotopes
      map.addSource('morphotopes-source', {
        type: 'vector',
        // url: 'pmtiles://http://127.0.0.1:8000/86873.pmtiles'   // use this when developing locally
        url: 'pmtiles://https://s3.cl4.du.cesnet.cz/4f4743b6_4043_4e02_a3ba_0452aa7523a2:uscuni-public/morphotopes.pmtiles'
      });


      map.addLayer({
        id: 'morphotopes',
        type: 'fill',
        source: 'morphotopes-source',
        maxzoom: 24,
        'layout': {
          'visibility': 'none'
        },
        'source-layer': 'morphotopes',
        paint: {
          "fill-color": fillColor,
          "fill-opacity": 0.7
        },
      });

      // show the cluster on click
      map.on('click', 'morphotopes', function (e) {
        new maplibregl.Popup()
          .setLngLat(e.lngLat)
          .setHTML('final_without_noise: ' + e.features[0].properties.final_without_noise + '<br />final: ' + e.features[0].properties.final)
          .addTo(map);
      });

      map.on('mouseenter', 'morphotopes', function () {
        map.getCanvas().style.cursor = 'pointer';
      });

      map.on('mouseleave', 'morphotopes', function () {
        map.getCanvas().style.cursor = '';
      });


      // add h3
      map.addSource('h3-source', {
        type: 'vector',
        // url: 'pmtiles://http://127.0.0.1:8000/86873.pmtiles'   // use this when developing locally
        url: 'pmtiles://https://s3.cl4.du.cesnet.cz/4f4743b6_4043_4e02_a3ba_0452aa7523a2:uscuni-public/h3.pmtiles'
      });


      map.addLayer({
        id: 'h3',
        type: 'fill',
        source: 'h3-source',
        maxzoom: 24,
        'layout': {
          'visibility': 'none'
        },
        'source-layer': 'h3',
        paint: {
          "fill-color": fillColor,
          "fill-opacity": 0.7
        },
      });

      // show the cluster on click
      map.on('click', 'h3', function (e) {
        new maplibregl.Popup()
          .setLngLat(e.lngLat)
          .setHTML('final_without_noise: ' + e.features[0].properties.final_without_noise + '<br />final: ' + e.features[0].properties.final)
          .addTo(map);
      });

      map.on('mouseenter', 'h3', function () {
        map.getCanvas().style.cursor = 'pointer';
      });

      map.on('mouseleave', 'h3', function () {
        map.getCanvas().style.cursor = '';
      });

      // add grid 250m
      map.addSource('grid-source', {
        type: 'vector',
        // url: 'pmtiles://http://127.0.0.1:8000/86873.pmtiles'   // use this when developing locally
        url: 'pmtiles://https://s3.cl4.du.cesnet.cz/4f4743b6_4043_4e02_a3ba_0452aa7523a2:uscuni-public/grid_250.pmtiles'
      });


      map.addLayer({
        id: 'grid',
        type: 'fill',
        source: 'grid-source',
        maxzoom: 24,
        'layout': {
          'visibility': 'none'
        },
        'source-layer': 'grid',
        paint: {
          "fill-color": fillColor,
          "fill-opacity": 0.7
        },
      });

      // show the cluster on click
      map.on('click', 'grid', function (e) {
        new maplibregl.Popup()
          .setLngLat(e.lngLat)
          .setHTML('final_without_noise: ' + e.features[0].properties.final_without_noise + '<br />final: ' + e.features[0].properties.final)
          .addTo(map);
      });

      map.on('mouseenter', 'grid', function () {
        map.getCanvas().style.cursor = 'pointer';
      });

      map.on('mouseleave', 'grid', function () {
        map.getCanvas().style.cursor = '';
      });

      // add regions hulls for debugging purposes
      map.addSource('geojson-source', {
        type: 'geojson',
        // data: 'http://127.0.0.1:8000/regions.geojson'   // use this when developing locally
        data: 'https://uscuni.org/himoc/regions.geojson'
      });

      map.addLayer({
        id: 'regions',
        type: 'line',
        source: 'geojson-source',
        'layout': {
          'visibility': 'none'
        },
        paint: {
          'line-color': '#ffffff',
          'line-width': 2,
          'line-dasharray': [2, 2]
        }
      });

      map.on('click', 'regions', function (e) {
        new maplibregl.Popup()
          .setLngLat(e.lngLat)
          .setHTML(e.features[0].properties.labels)
          .addTo(map);
      });

      // add layer control
      const layers = [
        { id: 'buildings', name: 'Buildings' },
        { id: 'morphotopes', name: 'Morphotopes' },
        { id: 'h3', name: 'H3' },
        { id: 'grid', name: 'Grid 250m' },
        { id: 'regions', name: 'Regions' }
      ];

      const layerControl = document.createElement('div');
      layerControl.id = 'layer-control';
      layerControl.style.position = 'absolute';
      layerControl.style.top = '10px';
      layerControl.style.right = '10px';
      layerControl.style.backgroundColor = 'white';
      layerControl.style.padding = '10px';
      layerControl.style.borderRadius = '5px';
      layerControl.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';

      layers.forEach(layer => {
        const layerCheckbox = document.createElement('input');
        layerCheckbox.type = 'checkbox';
        layerCheckbox.id = layer.id;
        layerCheckbox.checked = layer.id === 'buildings';
        layerCheckbox.onchange = (e) => {
          map.setLayoutProperty(layer.id, 'visibility', e.target.checked ? 'visible' : 'none');
        };

        const layerLabel = document.createElement('label');
        layerLabel.htmlFor = layer.id;
        layerLabel.textContent = layer.name;

        const layerControlItem = document.createElement('div');
        layerControlItem.appendChild(layerCheckbox);
        layerControlItem.appendChild(layerLabel);

        layerControl.appendChild(layerControlItem);
      });

      document.body.appendChild(layerControl);


      // add filter control for buildings
      const filterControl = document.createElement('div');
      filterControl.id = 'filter-control';
      filterControl.style.position = 'absolute';
      filterControl.style.top = '140px';
      filterControl.style.right = '10px';
      filterControl.style.backgroundColor = 'white';
      filterControl.style.padding = '10px';
      filterControl.style.borderRadius = '5px';
      filterControl.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
      filterControl.style.height = '600px';
      filterControl.style.overflowY = 'auto';

      const filterLabel = document.createElement('label');
      filterLabel.textContent = 'Filter by cluster: ';
      filterControl.appendChild(filterLabel);

      const filterSelect = document.createElement('select');
      filterSelect.id = 'filter-select';
      filterSelect.multiple = true;
      filterSelect.style.height = '100%';

      for (let i = 0; i <= 108; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        filterSelect.appendChild(option);
      }

      filterSelect.onchange = (e) => {
        const selectedOptions = Array.from(e.target.selectedOptions).map(option => option.value);
        if (selectedOptions.length === 0) {
          map.setFilter('buildings', null);
          map.setFilter('morphotopes', null);
          map.setFilter('h3', null);
          map.setFilter('grid', null);
        } else {
          map.setFilter('buildings', ['in', ['get', 'final_without_noise'], ['literal', selectedOptions]]);
          map.setFilter('morphotopes', ['in', ['get', 'final_without_noise'], ['literal', selectedOptions]]);
          map.setFilter('h3', ['in', ['get', 'final_without_noise'], ['literal', selectedOptions]]);
          map.setFilter('grid', ['in', ['get', 'final_without_noise'], ['literal', selectedOptions]]);
        }
      };

      filterControl.appendChild(filterSelect);
      document.body.appendChild(filterControl);

    });
    // add button to make map full screen
    // map.addControl(new maplibregl.FullscreenControl());

    // specify to use the globe projection
    map.on('style.load', () => {
      map.setProjection({
        type: 'globe',
      });
    });

    // include navigation control
    let nav = new maplibregl.NavigationControl();
    map.addControl(nav, 'top-left');

    const zoomLevel = document.createElement('div');
    zoomLevel.id = 'zoom-level';
    zoomLevel.style.position = 'absolute';
    zoomLevel.style.bottom = '10px';
    zoomLevel.style.left = '10px';
    zoomLevel.style.backgroundColor = 'white';
    zoomLevel.style.padding = '5px';
    zoomLevel.style.borderRadius = '5px';
    zoomLevel.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
    document.body.appendChild(zoomLevel);

    map.on('zoom', () => {
      zoomLevel.textContent = 'Zoom level: ' + map.getZoom().toFixed(2);
    });

  </script>
</body>

</html>